USE [Intune];
GO
SET NOCOUNT ON;

/***************************************************************************************************************************
Object: dbo.MsGraphSyncToSqlMetaData

History:
Date          Version    Author                   Notes:
04/27/2021    0.0        Benjamin Reynolds        Separate file created for better source control and management.
05/18/2021    0.0        Benjamin Reynolds        Updated table and created backup populate commands.
05/24/2021    0.0        Benjamin Reynolds        Changed table name; Added "StagingTable" column.
06/08/2021    0.0        Benjamin Reynolds        Updated to account for PowerShell (running in batches) which could say the table was
                                                  created when in fact there was an error creating it.
***************************************************************************************************************************/

-- Drop if already exists:
IF OBJECT_ID(N'dbo.MsGraphSyncToSqlMetaData') IS NOT NULL
BEGIN
    DROP TABLE dbo.MsGraphSyncToSqlMetaData;
    PRINT 'Table "MsGraphSyncToSqlMetaData" Dropped.';
END;
GO

-- Create Table:
CREATE TABLE dbo.MsGraphSyncToSqlMetaData ( [DBID] int IDENTITY(1,1) NOT NULL PRIMARY KEY CLUSTERED
                                          ,TableId nvarchar(16) NULL
                                          ,ParentId nvarchar(16) NULL
                                          ,TableName nvarchar(128) NOT NULL
                                          ,UriPart nvarchar(256) NOT NULL
                                          ,[Version] nvarchar(32) NOT NULL
                                          ,ExpandColumns nvarchar(512) NULL
                                          ,ExpandTableOrColumn nvarchar(6) NULL
                                          ,MetaDataEntityToUse nvarchar(128) NULL
                                          ,UriPartType nvarchar(16) NULL
                                          ,ReplacementTable nvarchar(128) NULL
                                          ,TargetTable nvarchar(128) NULL
                                          ,StagingTable nvarchar(128) NULL
                                          ,ParentCols nvarchar(1024) NULL
                                          ,SkipGraphMetaDataCheck bit NOT NULL DEFAULT(0)
                                          ,SelectColumns nvarchar(max) NULL
                                          ,ReportName nvarchar(128) NULL
                                          ,ReportFilter nvarchar(512) NULL
                                          ,[Enabled] bit NOT NULL DEFAULT(1)
                                          ,JobName nvarchar(128) NULL
                                          ,JobOrder tinyint NULL
                                          ,Notes nvarchar(max) NULL
                                          ) ON [PRIMARY];
GO
-- Since this can be run in batches via PowerShell we need to check for the existence before blindly saying it was created...it may have hit an error while creating:
IF OBJECT_ID(N'dbo.MsGraphSyncToSqlMetaData') IS NOT NULL
PRINT 'Table "MsGraphSyncToSqlMetaData" Created';
GO

/*******************************************************************************************
                                Backup Query for the table:
SELECT N',('+
       CASE WHEN TableId IS NULL THEN N'NULL,' ELSE N'N'''+TableId+N''',' END+
       CASE WHEN ParentId IS NULL THEN N'NULL,' ELSE N'N'''+ParentId+N''',' END+
       N'N'''+TableName+N''','+
       N'N'''+REPLACE(UriPart,N'''',N'''''')+N''','+
       N'N'''+Version+N''','+
       CASE WHEN ExpandColumns IS NULL THEN N'NULL,' ELSE N'N'''+ExpandColumns+N''',' END+
       CASE WHEN ExpandTableOrColumn IS NULL THEN N'NULL,' ELSE N'N'''+ExpandTableOrColumn+N''',' END+
       CASE WHEN MetaDataEntityToUse IS NULL THEN N'NULL,' ELSE N'N'''+MetaDataEntityToUse+N''',' END+
       CASE WHEN UriPartType IS NULL THEN N'NULL,' ELSE N'N'''+UriPartType+N''',' END+
       CASE WHEN ReplacementTable IS NULL THEN N'NULL,' ELSE N'N'''+ReplacementTable+N''',' END+
       CASE WHEN TargetTable IS NULL THEN N'NULL,' ELSE N'N'''+TargetTable+N''',' END+
       CASE WHEN StagingTable IS NULL THEN N'NULL,' ELSE N'N'''+StagingTable+N''',' END+
       --N'NULL,'+
       CASE WHEN ParentCols IS NULL THEN N'NULL,' ELSE N'N'''+ParentCols+N''',' END+
       CONVERT(nvarchar(2),SkipGraphMetaDataCheck)+N','+
       CASE WHEN SelectColumns IS NULL THEN N'NULL,' ELSE N'N'''+SelectColumns+N''',' END+
       CASE WHEN ReportName IS NULL THEN N'NULL,' ELSE N'N'''+ReportName+N''',' END+
       CASE WHEN ReportFilter IS NULL THEN N'NULL,' ELSE N'N'''+REPLACE(ReportFilter,N'''',N'''''')+N''',' END+
       CONVERT(nvarchar(2),Enabled)+N','+
       CASE WHEN JobName IS NULL THEN N'NULL,' ELSE N'N'''+JobName+N''',' END+
       CASE WHEN JobOrder IS NULL THEN N'NULL,' ELSE CONVERT(nvarchar(5),JobOrder)+N',' END+
       CASE WHEN Notes IS NULL THEN N'NULL' ELSE N'N'''+REPLACE(REPLACE(REPLACE(Notes,N'''',N''''''),CHAR(10),N'''+CHAR(10)+N'''),CHAR(13),N'''+CHAR(13)+N''')+N'''' END+
       N')'
  FROM dbo.MsGraphSyncToSqlMetaData
 --WHERE Enabled = 0
 ORDER BY DBID;
*******************************************************************************************/
DECLARE  @ErrorMessage  nvarchar(4000)
        ,@ErrorNumber   int;
BEGIN TRY
INSERT dbo.MsGraphSyncToSqlMetaData (TableId,ParentId,TableName,UriPart,[Version],ExpandColumns,ExpandTableOrColumn,MetaDataEntityToUse,UriPartType,ReplacementTable,TargetTable,StagingTable,ParentCols,SkipGraphMetaDataCheck,SelectColumns,ReportName,ReportFilter,[Enabled],JobName,JobOrder,Notes)
VALUES -- Default Values; Update/Backup using the query above from time to time if changes occur
 (N'aadDvc',NULL,N'devices',N'devices',N'v1.0',NULL,NULL,N'microsoft.graph.device',NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_AAD',1,NULL)
,(NULL,N'aadMem',N'aadGroupMembership',N'groups/{id}/members',N'v1.0',NULL,NULL,NULL,N'DrillDownData',N'AadGroups',N'aadGroupMembership',NULL,NULL,1,NULL,NULL,NULL,0,N'MsGraphSyncToSql_AAD',50,NULL)
,(N'wadi',NULL,N'WindowsAutopilotDeviceIdentities',N'deviceManagement/WindowsAutopilotDeviceIdentities',N'beta',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Autopilot',1,NULL)
,(N'wapdi',NULL,N'WindowsAutopilotDeviceIdentityIds',N'deviceManagement/WindowsAutopilotDeviceIdentities',N'beta',NULL,NULL,NULL,NULL,NULL,N'WindowsAutopilotDeviceIdentityIds',NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Autopilot',50,NULL)
,(NULL,N'wapdi',N'windowsAutopilotDeviceIdentities',N'deviceManagement/windowsAutopilotDeviceIdentities/{id}/?$expand=deploymentProfile',N'beta',NULL,NULL,NULL,N'DrillDownData',N'WindowsAutopilotDeviceIdentityIds',NULL,NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Autopilot',51,NULL)
,(N'detapps',NULL,N'detectedApps',N'deviceManagement/detectedApps',N'beta',NULL,NULL,N'deviceManagement',NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_DetectedApps',1,NULL)
,(NULL,NULL,N'DetectedAppsAggregate',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'DetectedAppsAggregate',NULL,1,N'MsGraphSyncToSql_DetectedApps',2,NULL)
,(NULL,N'detapps',N'detectedApps_deviceDetails',N'deviceManagement/detectedapps/{id}/managedDevices',N'beta',NULL,NULL,NULL,N'DrillDownData',N'<detectedApps OR a View that contains specific Ids from this table>',N'detectedApps_deviceDetails',NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_DetectedApps',50,N'CREATE TABLE dbo.detectedApps_deviceDetails ( ParentId nvarchar(64) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                             ,id nvarchar(36) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                             ) ON [PRIMARY];')
,(NULL,NULL,N'IntuneDevices',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,N'IntuneDevices',NULL,NULL,0,NULL,N'Devices',NULL,1,N'MsGraphSyncToSql_Devices',1,NULL)
,(N'mgdDvc',NULL,N'managedDevices',N'deviceManagement/managedDevices',N'beta',NULL,NULL,N'deviceManagement',NULL,NULL,NULL,NULL,NULL,0,N'id,userId,deviceName,managedDeviceOwnerType,deviceActionResults,enrolledDateTime,lastSyncDateTime,operatingSystem,complianceState,jailBroken,managementAgent,osVersion,easActivated,easDeviceId,easActivationDateTime,azureADRegistered,deviceEnrollmentType,activationLockBypassCode,emailAddress,azureADDeviceId,deviceRegistrationState,deviceCategoryDisplayName,isSupervised,exchangeLastSuccessfulSyncDateTime,exchangeAccessState,exchangeAccessStateReason,remoteAssistanceSessionUrl,remoteAssistanceSessionErrorDetails,isEncrypted,userPrincipalName,model,manufacturer,imei,complianceGracePeriodExpirationDateTime,serialNumber,phoneNumber,androidSecurityPatchLevel,userDisplayName,configurationManagerClientEnabledFeatures,wiFiMacAddress,deviceHealthAttestationState,subscriberCarrier,meid,totalStorageSpaceInBytes,freeStorageSpaceInBytes,managedDeviceName,partnerReportedThreatState,configurationManagerClientHealthState,udid,autopilotEnrolled,chassisType,deviceType,managementState,joinType,skuFamily,skuNumber',NULL,NULL,1,N'MsGraphSyncToSql_Devices',2,NULL)
,(NULL,N'mgdDvc',N'AzureAdJoinedRegisteredOwners',N'devices?$filter=deviceId eq ''{azureADDeviceId}''&$expand=registeredOwners',N'v1.0',NULL,NULL,N'microsoft.graph.device',N'DrillDownData',N'v_IntuneHybridAadjOwners',N'AzureAdJoinedRegisteredOwners',NULL,NULL,1,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Devices',50,N'This can take a really long time to sync depending on the size of the environment')
,(NULL,N'mgdDvc',N'devicesPartnerReportedThreatState',N'deviceManagement/managedDevices/{deviceId}/?$select=id,partnerReportedThreatState',N'beta',NULL,NULL,N'deviceManagement',N'DrillDownData',N'<managedDevices OR a view containing specific Ids from the table>',N'devicesPartnerReportedThreatState',NULL,NULL,1,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Devices',51,N'CREATE TABLE dbo.devicesPartnerReportedThreatState ( id nvarchar(36) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                    ,partnerReportedThreatState nvarchar(14) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                    ) ON [PRIMARY];')
,(NULL,N'mgdDvc',N'managedDevices_windowsProtectionState',N'deviceManagement/managedDevices?$expand=windowsProtectionState($expand=detectedMalwareState)&$select=id,windowsProtectionState',N'beta',NULL,NULL,N'deviceManagement',N'SpecificURL',NULL,N'managedDevices_windowsProtectionState',NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Devices',52,N'CREATE TABLE dbo.managedDevices_windowsProtectionState ( id nvarchar(36) NOT NULL --PRIMARY KEY CLUSTERED'+CHAR(13)+N''+CHAR(10)+N'                                                        ,windowsProtectionState_JSON nvarchar(max) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                        ) ON [PRIMARY];')
,(N'mobapp',NULL,N'mobileApps',N'deviceAppManagement/mobileApps',N'beta',N'assignments',N'Both',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_MobileApps',1,NULL)
,(N'moappc',NULL,N'mobileAppConfigurations',N'deviceAppManagement/mobileAppConfigurations',N'beta',N'assignments',N'Table',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_MobileApps',2,NULL)
,(NULL,N'mobapp',N'mobileApps_installSummary',N'deviceAppManagement/mobileApps/{id}/installSummary',N'beta',NULL,NULL,NULL,N'DrillDownData',N'mobileApps',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_MobileApps',3,NULL)
,(NULL,N'mobapp',N'mobileApps_deviceStatuses',N'deviceAppManagement/mobileApps/{id}/deviceStatuses',N'beta',NULL,NULL,NULL,N'DrillDownData',N'mobileApps',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_MobileApps',4,NULL)
,(NULL,N'moappc',N'mobileAppConfigurations_deviceStatusSummary',N'deviceAppManagement/mobileAppConfigurations/{id}/deviceStatusSummary',N'beta',NULL,NULL,NULL,N'DrillDownData',N'mobileAppConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_MobileApps',5,NULL)
,(NULL,N'moappc',N'mobileAppConfigurations_deviceStatuses',N'deviceAppManagement/mobileAppConfigurations/{id}/deviceStatuses',N'beta',NULL,NULL,NULL,N'DrillDownData',N'mobileAppConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_MobileApps',6,NULL)
,(NULL,N'mobapp',N'mobileApps_userStatuses',N'deviceAppManagement/mobileApps/{id}/userStatuses',N'beta',NULL,NULL,NULL,N'DrillDownData',N'mobileApps',NULL,NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_MobileApps',50,NULL)
,(NULL,NULL,N'DeviceCompliance',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'DeviceCompliance',NULL,1,N'MsGraphSyncToSql_ReportExports',2,NULL)
,(NULL,NULL,N'ComanagedDeviceWorkloads',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'ComanagedDeviceWorkloads',NULL,1,N'MsGraphSyncToSql_ReportExports',3,NULL)
,(NULL,NULL,N'PolicyNonComplianceAgg',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'PolicyNonComplianceAgg',NULL,1,N'MsGraphSyncToSql_ReportExports',4,NULL)
,(NULL,NULL,N'MAMAppProtectionStatus',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'MAMAppProtectionStatus',NULL,1,N'MsGraphSyncToSql_ReportExports',5,NULL)
,(NULL,NULL,N'MAMAppConfigurationStatus',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'MAMAppConfigurationStatus',NULL,1,N'MsGraphSyncToSql_ReportExports',6,NULL)
,(NULL,NULL,N'DevicesWithInventory',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'DevicesWithInventory',NULL,1,N'MsGraphSyncToSql_ReportExports',8,NULL)
,(NULL,NULL,N'DeviceNonCompliance',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'DeviceNonCompliance',NULL,0,N'MsGraphSyncToSql_ReportExports',50,NULL)
,(NULL,NULL,N'ActiveMalware',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'ActiveMalware',NULL,0,N'MsGraphSyncToSql_ReportExports',51,N'Table needs to be defined and created before enabling this item')
,(NULL,NULL,N'DefenderAgents',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'DefenderAgents',NULL,0,N'MsGraphSyncToSql_ReportExports',52,N'Table needs to be defined and created before enabling this item')
,(NULL,NULL,N'FeatureUpdateDeviceState',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'FeatureUpdateDeviceState',NULL,0,N'MsGraphSyncToSql_ReportExports',53,N'Table needs to be defined and created before enabling this item')
,(NULL,NULL,N'FeatureUpdatePolicyFailuresAggregate',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'FeatureUpdatePolicyFailuresAggregate',NULL,0,N'MsGraphSyncToSql_ReportExports',54,N'Table needs to be defined and created before enabling this item')
,(NULL,NULL,N'Malware',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'Malware',NULL,0,N'MsGraphSyncToSql_ReportExports',55,N'Table needs to be defined and created before enabling this item')
,(NULL,NULL,N'UnhealthyDefenderAgents',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'UnhealthyDefenderAgents',NULL,0,N'MsGraphSyncToSql_ReportExports',56,N'Table needs to be defined and created before enabling this item')
,(NULL,NULL,N'DeviceFailuresByFeatureUpdatePolicy',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',NULL,NULL,NULL,NULL,0,NULL,N'DeviceFailuresByFeatureUpdatePolicy',NULL,0,N'MsGraphSyncToSql_ReportExports',57,N'Table needs to be defined and created before enabling this item')
,(N'dcp',NULL,N'deviceCompliancePolicies',N'deviceManagement/deviceCompliancePolicies',N'v1.0',N'assignments',N'Both',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',1,NULL)
,(N'dc',NULL,N'deviceConfigurations',N'deviceManagement/deviceConfigurations',N'beta',N'assignments',N'Both',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',2,NULL)
,(N'dms',NULL,N'deviceManagementScripts',N'deviceManagement/deviceManagementScripts',N'beta',N'assignments',N'Table',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',3,NULL)
,(N'wapdp',NULL,N'WindowsAutopilotDeploymentProfiles',N'deviceManagement/WindowsAutopilotDeploymentProfiles',N'beta',N'assignments',N'Both',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',4,NULL)
,(N'gpc',NULL,N'groupPolicyConfigurations',N'deviceManagement/groupPolicyConfigurations',N'beta',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',5,NULL)
,(N'gpd',NULL,N'groupPolicyDefinitions',N'deviceManagement/groupPolicyDefinitions',N'beta',N'definitionFile',N'Both',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',6,NULL)
,(N'apEvt',NULL,N'autopilotEvents',N'deviceManagement/autopilotEvents?$top=250',N'beta',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',7,NULL)
,(N'raa',NULL,N'remoteActionAudits',N'deviceManagement/remoteActionAudits',N'beta',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',8,NULL)
,(N'mdencryp',NULL,N'managedDeviceEncryptionStates',N'deviceManagement/managedDeviceEncryptionStates',N'beta',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',9,NULL)
,(NULL,N'dc',N'deviceConfigurations_deviceStatuses',N'deviceManagement/deviceConfigurations/{id}/deviceStatuses',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_deviceConfigurations_For_deviceStatuses',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',10,N'The ReplacementTable can be updated to use either deviceConfigurations OR a View that contains specific Ids from this table.')
,(NULL,N'dc',N'deviceConfigurations_deviceStatusOverview',N'deviceManagement/deviceConfigurations/{id}/deviceStatusOverview',N'beta',NULL,NULL,NULL,N'DrillDownData',N'deviceConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',11,NULL)
,(NULL,N'dc',N'deviceConfigurations_userStatusOverview',N'deviceManagement/deviceConfigurations/{id}/userStatusOverview',N'beta',NULL,NULL,NULL,N'DrillDownData',N'deviceConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',12,NULL)
,(NULL,N'dc',N'deviceConfigurations_deviceSettingStateSummaries',N'deviceManagement/deviceConfigurations/{id}/deviceSettingStateSummaries',N'beta',NULL,NULL,NULL,N'DrillDownData',N'deviceConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',13,NULL)
,(NULL,N'dcp/gpc',N'deviceCompliancePolicies_deviceStatusOverview',N'deviceManagement/deviceCompliancePolicies/{id}/deviceStatusOverview',N'v1.0',NULL,NULL,NULL,N'DrillDownData',N'v_IdsForDCPDeviceStatusOverview',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',14,NULL)
,(NULL,N'dcp/gpc',N'deviceCompliancePolicies_userStatusOverview',N'deviceManagement/deviceCompliancePolicies/{id}/userStatusOverview',N'v1.0',NULL,NULL,NULL,N'DrillDownData',N'v_IdsForDCPDeviceStatusOverview',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',15,NULL)
,(NULL,N'dms',N'deviceManagementScripts_deviceRunStates',N'deviceManagement/deviceManagementScripts/{id}/deviceRunStates?$expand=managedDevice($select=id)',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_deviceManagementScripts',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',16,NULL)
,(NULL,N'dms',N'deviceManagementScripts_runSummary',N'deviceManagement/deviceManagementScripts/{id}/runSummary',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_deviceManagementScripts',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',17,NULL)
,(NULL,N'wapdp',N'WindowsAutopilotDeploymentProfiles_assignedDevices',N'deviceManagement/WindowsAutopilotDeploymentProfiles/{id}/assignedDevices',N'beta',NULL,NULL,NULL,N'DrillDownData',N'WindowsAutopilotDeploymentProfiles',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',18,NULL)
,(NULL,N'gpc',N'groupPolicyConfigurations_assignments',N'deviceManagement/groupPolicyConfigurations/{id}/assignments',N'beta',NULL,NULL,NULL,N'DrillDownData',N'groupPolicyConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',19,NULL)
,(N'gpcdv',N'gpc',N'groupPolicyConfigurations_definitionValues',N'deviceManagement/groupPolicyConfigurations/{id}/definitionValues?$expand=definition',N'beta',NULL,NULL,NULL,N'DrillDownData',N'groupPolicyConfigurations',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',20,NULL)
,(NULL,N'gpcdv',N'groupPolicyConfigurations_presentationValues',N'deviceManagement/groupPolicyConfigurations/{ParentId}/definitionValues/{id}/presentationValues?$expand=presentation',N'beta',NULL,NULL,N'graph.groupPolicyConfiguration',N'DrillDownData',N'groupPolicyConfigurations_definitionValues',N'groupPolicyConfigurations_presentationValues',NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',21,NULL)
,(N'dcpsss',N'dcp',N'deviceCompliancePolicies_deviceSettingStateSummaries',N'deviceManagement/deviceCompliancePolicies/{id}/deviceSettingStateSummaries',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_deviceCompliancePolicies_For_deviceSettingStateSummaries',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',22,N'The ReplacementTable can be updated to use either deviceCompliancePolicies OR a View that contains specific Ids from this table.')
,(N'dcpdcss',N'dcpsss',N'deviceComplianceSettingStates',N'deviceManagement/deviceCompliancePolicySettingStateSummaries/{settingName}/deviceComplianceSettingStates',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_CompliancePolicySettings',N'deviceComplianceSettingStates',NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',23,NULL)
,(NULL,N'dcp',N'deviceCompliancePolicies_deviceStatuses',N'deviceManagement/deviceCompliancePolicies/{id}/deviceStatuses',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_deviceCompliancePolicies_For_devicesStatuses',NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_Various',24,N'The ReplacementTable can be updated to use either deviceCompliancePolicies OR a View that contains specific Ids from this table.')
,(NULL,N'dc',N'managedDeviceCertificateStates',N'deviceManagement/deviceConfigurations/<Add Your Specific Id Here>/microsoft.graph.windows81SCEPCertificateProfile/managedDeviceCertificateStates',N'beta',NULL,NULL,NULL,N'SpecificURL',NULL,N'managedDeviceCertificateStates',NULL,N',@{"ParentId" = "<Add Your Specific Id Here>"; "ParentOdataType" = "microsoft.graph.windows81SCEPCertificateProfile"}',0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Various',50,N'CREATE TABLE dbo.managedDeviceCertificateStates ( ParentOdataType nvarchar(256) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,ParentId nvarchar(36) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,id nvarchar(147) NOT NULL --PRIMARY KEY CLUSTERED -- This can''t be set yet since there seems to be a bug with this...'+CHAR(13)+N''+CHAR(10)+N'                                                 ,devicePlatform nvarchar(17) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateKeyUsage nvarchar(20) NOT NULL -- this seems to be a bug too...the value should be an enum, but instead it is an int'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateValidityPeriodUnits nvarchar(6) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateIssuanceState nvarchar(28) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateKeyStorageProvider nvarchar(34) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectNameFormat nvarchar(27) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectAlternativeNameFormat nvarchar(22) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateRevokeStatus nvarchar(7) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateProfileDisplayName nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,deviceDisplayName nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,userDisplayName nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateExpirationDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateLastIssuanceStateChangedDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,lastCertificateStateChangeDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateIssuer nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateThumbprint nvarchar(40) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSerialNumber nvarchar(40) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateKeyLength int NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateEnhancedKeyUsage nvarchar(128) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateValidityPeriod int NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectNameFormatString nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectAlternativeNameFormatString nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateIssuanceDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateErrorCode int NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ) ON [PRIMARY];')
,(NULL,N'dc',N'managedDeviceCertificateStates',N'deviceManagement/deviceConfigurations/<Add Your Specific Id Here>/microsoft.graph.iosScepCertificateProfile/managedDeviceCertificateStates',N'beta',NULL,NULL,NULL,N'SpecificURL',NULL,N'managedDeviceCertificateStates',NULL,N',@{"ParentId" = "<Add Your Specific Id Here>"; "ParentOdataType" = "microsoft.graph.iosScepCertificateProfile"}',0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Various',50,N'CREATE TABLE dbo.managedDeviceCertificateStates ( ParentOdataType nvarchar(256) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,ParentId nvarchar(36) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,id nvarchar(147) NOT NULL --PRIMARY KEY CLUSTERED -- This can''t be set yet since there seems to be a bug with this...'+CHAR(13)+N''+CHAR(10)+N'                                                 ,devicePlatform nvarchar(17) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateKeyUsage nvarchar(20) NOT NULL -- this seems to be a bug too...the value should be an enum, but instead it is an int'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateValidityPeriodUnits nvarchar(6) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateIssuanceState nvarchar(28) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateKeyStorageProvider nvarchar(34) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectNameFormat nvarchar(27) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectAlternativeNameFormat nvarchar(22) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateRevokeStatus nvarchar(7) NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateProfileDisplayName nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,deviceDisplayName nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,userDisplayName nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateExpirationDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateLastIssuanceStateChangedDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,lastCertificateStateChangeDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateIssuer nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateThumbprint nvarchar(40) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSerialNumber nvarchar(40) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateKeyLength int NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateEnhancedKeyUsage nvarchar(128) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateValidityPeriod int NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectNameFormatString nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateSubjectAlternativeNameFormatString nvarchar(256) NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateIssuanceDateTime datetime2 NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ,certificateErrorCode int NOT NULL'+CHAR(13)+N''+CHAR(10)+N'                                                 ) ON [PRIMARY];')
,(NULL,N'dc',N'SpecificConfiguration_deviceStatuses',N'deviceManagement/deviceConfigurations/<Add Your Specific Id Here>/deviceStatuses?$filter=(platform%20eq%200)',N'beta',NULL,NULL,NULL,N'SpecificURL',NULL,N'SpecificConfiguration_deviceStatuses',NULL,N',@{"ParentId" = "<Add Your Specific Id Here>"}',0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Various',51,N'The table should have the same definition as deviceConfigurations_deviceStatuses.')
,(NULL,N'dcp',N'SpecificCompliancePolicy_deviceStatuses',N'deviceManagement/deviceCompliancePolicies/<Add Your Specific Id Here>/deviceStatuses?$filter=(platform%20eq%200)',N'beta',NULL,NULL,NULL,N'SpecificURL',NULL,N'SpecificCompliancePolicy_deviceStatuses',NULL,N',@{"ParentId" = "<Add Your Specific Id Here>"}',0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Various',52,N'The table should have the same definition as deviceCompliancePolicies_deviceStatuses.')
,(NULL,N'dc',N'WiFiConfigurations_deviceStatuses',N'deviceManagement/deviceConfigurations/{id}/deviceStatuses?$filter=(platform%20eq%200)',N'beta',NULL,NULL,NULL,N'DrillDownData',N'v_WiFiConfigurations',N'WiFiConfigurations_deviceStatuses',NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_Various',53,NULL)
,(N'mdmwip',NULL,N'mdmWindowsInformationProtectionPolicies',N'deviceAppManagement/mdmWindowsInformationProtectionPolicies',N'v1.0',N'protectedAppLockerFiles,exemptAppLockerFiles,assignments',N'Both',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',1,NULL)
,(N'dcpSsSmry',NULL,N'deviceCompliancePolicySettingStateSummaries',N'deviceManagement/deviceCompliancePolicySettingStateSummaries',N'v1.0',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',2,NULL)
,(N'dhs',NULL,N'deviceHealthScripts',N'deviceManagement/deviceHealthScripts',N'beta',N'assignments,runSummary',N'Table',NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',3,NULL)
,(NULL,N'mdmwip',N'mdmWindowsInformationProtectionPolicies_deviceStatusOverview',N'deviceManagement/deviceConfigurations/{Id}/deviceStatusOverview',N'v1.0',NULL,NULL,NULL,N'DrillDownData',N'v_mdmWindowsInformationProtectionPolicyIdsFixed',N'mdmWindowsInformationProtectionPolicies_deviceStatusOverview',NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',4,NULL)
,(NULL,N'mdmwip',N'mdmWindowsInformationProtectionPolicies_userStatusOverview',N'deviceManagement/deviceConfigurations/{Id}/userStatusOverview',N'v1.0',NULL,NULL,NULL,N'DrillDownData',N'v_mdmWindowsInformationProtectionPolicyIdsFixed',N'mdmWindowsInformationProtectionPolicies_userStatusOverview',NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',5,NULL)
,(NULL,N'mdmwip',N'mdmWindowsInformationProtectionPolicies_deviceSettingStateSummaries',N'deviceManagement/deviceConfigurations/{Id}/deviceSettingStateSummaries',N'v1.0',NULL,NULL,NULL,N'DrillDownData',N'v_mdmWindowsInformationProtectionPolicyIdsFixed',N'mdmWindowsInformationProtectionPolicies_deviceSettingStateSummaries',NULL,NULL,0,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',6,NULL)
,(NULL,N'dhs',N'deviceHealthScripts_getRemediationHistory',N'deviceManagement/deviceHealthScripts/{id}/getRemediationHistory',N'beta',NULL,NULL,NULL,N'DrillDownData',N'deviceHealthScripts',NULL,NULL,NULL,1,NULL,NULL,NULL,1,N'MsGraphSyncToSql_WIP_DHS',7,NULL)
,(NULL,N'dhs',N'DeviceRunStatesByProactiveRemediation',N'deviceManagement/reports/exportJobs',N'beta',NULL,NULL,NULL,N'ReportExport',N'deviceHealthScripts',NULL,NULL,NULL,0,NULL,N'DeviceRunStatesByProactiveRemediation',N'PolicyId eq ''{id}''',1,N'MsGraphSyncToSql_WIP_DHS',8,NULL)
,(NULL,N'dhs',N'deviceHealthScripts_deviceRunStates',N'deviceManagement/deviceHealthScripts/{Id}/deviceRunStates?$expand=managedDevice($select=id)',N'beta',NULL,NULL,NULL,N'DrillDownData',N'deviceHealthScripts',NULL,NULL,NULL,0,NULL,NULL,NULL,0,N'MsGraphSyncToSql_WIP_DHS',50,N'This can take a really long time to sync depending on the size of the environment')
;

PRINT 'Table "MsGraphSyncToSqlMetaData" Populated';
END TRY
BEGIN CATCH
SELECT @ErrorMessage  = ERROR_MESSAGE()
      ,@ErrorNumber   = ERROR_NUMBER();
PRINT 'Error Populating "MsGraphSyncToSqlMetaData"!';
PRINT N' *** Error Number: '+CONVERT(nvarchar(20),@ErrorNumber);
PRINT N' *** Error Message: '+@ErrorMessage;
END CATCH;
GO